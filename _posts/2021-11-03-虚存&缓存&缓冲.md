---
layout: post
--- 

## 虚拟内存与缓存的关系

虚拟内存系统中的两个关键技术与缓存有关：TLB和请求页替换。

TLB包含一个小型的高速硬件加速装置，极大提高了请求分页系统的性能。实际上，TLB不过是地址映射的缓存：当它查找一个页表目时，MMU将条目存储在TLB中。对同一页面的连续查找将从TLB得到答案。

与其他高速缓存系统一样，TLB通常使用最近最少使用替换策略。从概念上讲，当引用一个条目时，TLB将条目移到列表的前面；当一个新的引用发生并且缓存已满时，TLB会丢弃列表后面的页表条目，以便为新条目腾出空间。当然，TLB无法在内存中保存一个链表。相反，TLB包含了数字电路，将高速移动到一个专门用途的内容可寻址存储器上。

请求分页可以看作一种缓存形式。缓存对应于主存，而数据存储则对应于需要之前一直在外部存储保存的页面。此外，页面替换策略用作缓存替换策略。从表面上看，分页借用了“从缓存中替换的策略”这个短语。

有趣的是，将请求分页看作缓存可以帮助我们理解一个重要概念：虚拟地址空间如何比物理内存大得多。像缓存一样，物理内存只占页面的一小部分。从对缓存的分析中，我们知道请求分页虚拟内存的性能可以接近物理内存的性能。

## 虚拟内存缓存和缓存刷新

如果缓存与虚拟内存一起使用，那么缓存应该放在处理器和MMU之间，还是在MMU和物理内存之间？也就是说，内存缓存是存储虚拟地址和内容对，还是存储物理地址和内容对？答案是复杂的。一方面，使用虚拟地址可以提高内存访问速度，因为缓存可以在MMU将该虚拟地址转换为物理地址之前进行响应。另一方面，使用虚拟地址的缓存需要额外的硬件，允许缓存与虚拟内存系统交互。要理解其中的原因，请注意，虚拟内存系统通常为每个正在运行的应用程序提供相同的地址范围（即，每个进程都有从0开始的地址）。现在考虑一下当操作系统执行一个上下文切换时（即停止运行一个进程并运行另一个进程）会发生什么。假设在切换前，内存缓存包含地址为2000的条目。如果在上下文切换期间缓存没有变化，而新进程访问位置2000，则缓存将返回位置2000的旧进程中的值。因此，当它从一个进程切换到另一个进程时，操作系统也必须改变缓存中的项。

当多个进程使用相同的地址范围时，可以通过缓存刷新或者消除二义性的标识符解决。

## 缓冲与缓存

它们的主要区别在于项的访问方式：高速缓存系统针对随机访问进行了优化，而缓冲系统针对顺序访问进行优化。

本质上，高速缓存存储的是已被引用过的项，而缓冲存储的则是将要被引用的项（假定为顺序访问）。因此，在虚拟系统中，高速缓存存储整个内存页面--当页面上的任意字节被引用时，整个页面将被置入高速缓存中。与之相反，缓冲区存储连续的字节，当一个字节被引用，缓冲系统会预加载接下来的字节--如果被引用的字节位于页面尾部，缓冲系统将预加载下一页的字节。

